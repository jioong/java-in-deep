# 集群容错

集群服务调用失败后，服务框架需要能够在底层自动容错。

## 集群容错场景

### 通信链路故障

这里的链路指的是消费者和服务者之间的链路(通常为长连接)，可能导致链路中断的原因有：
1. 通信过程中，对方突然宕机导致链路中断。
2. 通信过程中，对方因为解码失败等原因Rest掉连接，导致链路失败。
3. 通信过程中，消费者write SocketChannel发生IOException异常导致链路中断。
4. 通信过程中，消费者read SocketChannel发生IOExceeption异常导致链路中断。
5. 通信双方因心跳超时，主动 close SocketChannel导致链路中断。
6. 通信过程中，网络发生闪断故障。
7. 通信过程中，交换机异常导致链路中断。
8. 通信过程中，消费者或服务者因长时间Full GC导致链路中断。

### 服务端超时

当服务端无法在指定的时间内返回应答给客户端，就会发生超时。

### 服务端调用失败

导致服务端调用失败的原因主要包括：
1. 服务端解码失败，会返回消息解码失败异常。
2. 服务端发生动态流控，返回流控异常。
3. 服务端消息队列积压率超过最大阈值，返回系统拥塞异常。
4. 访问权限校验失败，返回权限相关异常。
5. 违反SLA策略，返回SLA相关异常。
6. 其他系统异常。

需要指出的是，服务调用异常不包括业务层面的处理异常，例如数据库操作异常、用户记录不存在异常等。

## 容错策略

集群容错是系统自动执行的，上层用户并不关心底层的服务调用过程。

### 失败自动切换FailOver

自动切换是指当发生RPC调用异常时，**重新选路**，查找下一个可用的服务提供者。
服务发布的时候，可以指定服务集群容错策略，。**消费者可以覆盖服务提供者的通用配置，实现个性化的容错策略。**

Failover策略的设计思路如下：
* 消费者路由操作完成之后，获得目标地址，调用通信框架的消息发送接口发送请求，监听服务端应答。
* 如果返回的结果是RPC调用异常，根据消费者集群容错的策略进行**容错路由**。
* 如果是Failover，则重新返回到路由Handler的入口，从路由节点继续执行。
* 选路完成之后，堆目标地址进行对比，防止重新路由到故障服务节点。

Failover策略的应用场景如下：
1. 读操作，因为通常它是幂等的。
2. 幂等性服务。

注意，失败重试会增加服务调用的时延。因此必须对重试的最大次数作限制。

### 失败通知Failback

Failback的设计方案如下：
* 服务框架获取到服务提供者返回的RPC异常响应之后，根据策略进行容错。如果是该模式，则**不再重试其他服务提供者**，而是将异常通知给消费者，由消费者捕获异常进行后续处理。

### 失败缓存 Failcache

该策略是失败自动恢复的一种，在实际项目中的应用场景如下：
1. 服务有状态路由，必须定点发送到指定的服务提供者。服务框架需将消息缓存起来，等待周期T，重新发送，直到服务提供者能够正常处理该消息。
2. 对时延要求不敏感的服务。
3. 通知类服务。

为了保证可靠性，该策略在设计的时候需要考虑如下因素：
1. 缓存时间、缓存对象上限数等需要作出限制，防止内存溢出。
2. 缓存淘汰算法的选择，是否支持用户配置。
3. 定时重试的周期T、重试的最大次数等需要作出限制，并支持用户指定。

重试达到最大上限仍失败，需要丢弃消息，记录异常日志。

### 快速失败 Failfast

在业务高峰期，对于一些非核心的业务，希望只调用一次，失败也不再重试，为重要的核心服务节约宝贵的运行资源。
该策略的设计比较简单，获取到服务调用异常之后，直接忽略异常，记录异常日志。

### 容错策略扩展

在集群容错设计的时候，需要考虑扩展性，主要从以下几方面进行：
1. 容错接口的开放。
2. 屏蔽底层的细节，用户定制简单。
3. 配置应该天生支持的扩展，不要让用户扩展服务框架Schema。

