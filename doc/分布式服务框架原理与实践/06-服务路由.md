# 服务路由

分布式服务框架上线运行时都是**集群组网**,这意味着集群中存在这个某个服务的多实例部署，消费者如何从服务列表中选择合适的服务提供者进行调用，这就涉及到**服务路由**。

## 透明化路由

消费者如果需要感知服务提供者的地址信息，这违反了**透明化路由**原则。

### 基于服务注册中心的订阅发布

在分布式服务框架中，服务注册中心用于**存储服务提供者的地址信息、服务发布相关的属性**，消费者通过**主动查询和被动通知**的方式获取服务提供者的地址信息，而不需要
在代码中硬编码服务提供者地址信息。
> 消费者只需要知道当前系统发布了哪些服务，而不需要知道服务具体存在于什么位置，这就是透明化路由。

它的工作原理主要是基于服务注册中心(如ZooKeeper)的订阅发布机制。

服务消费者和服务提供者通过注册中心提供的SDK与注册中心建立链路，服务提供者将需要发布的**服务地址信息和属性列表**写入注册中心。服务消费者通过本地引用的接口名等信息，
从服务注册中心获取服务提供者列表，缓存到本地。

注册中心检测到服务提供者列表变更之后，将变更内容主动推送给服务消费者，消费者根据变更列表，动态刷新本地缓存的服务提供者列表。

### 消费者缓存服务提供者列表

消费者调用服务提供者时，不需要每次调用都去服务注册中心查询服务提供者地址列表，消费者直接从本地缓存的服务提供者路由表中查询地址信息，根据路由策略进行服务选路。

**当服务提供者发生变更时，注册中心主动将变更内容推送给消费者，由消费者动态刷新本地缓存的服务路由表，保证服务路由信息的实时准确性。**


## 负载均衡

### 随机

采用随机算法进行负载均衡，通常在对等集群组网中，随机路由算法消息分布还是比较均匀的。它主要有两个缺点：
1. 在一个截面上碰撞的概率较高。
2. 非对等集群组网，或者硬件配置差异较大，会导致各节点负载不均匀。

### 轮循

它的主要缺点是：慢的提供者累积请求的问题。

### 服务调用时延

消费者缓存所有服务提供者的**服务调用时延**，周期性的计算服务调用平均时延，然后计算每个服务提供者服务调用时延与平均时延的差值，**根据差值大小动态调整权重**，
保证服务时延大的服务提供者接收更少的消息，**防止消息堆积**。

它的特点是保证处理能力强的服务提供者收到更多的消息，通过动态自动权重调整消除服务调用时延的**震荡范围**。

### 一致性哈希

引入虚拟节点的思想。

### 粘滞连接

粘滞连接用于**有状态服务**，尽可能让客户端总是向同一个提供者发起服务调用，除非该提供者宕机，再连接另一台。
由于服务通常被设计为无状态的，因此该方法在实际项目中很少用到。

## 本地路由优先策略

### injvm 模式

本地JVM内部也发布了需要消费的服务，该场景下，从性能、可靠性等角度考虑，需要**优先调用本JVM内部的服务提供者**，这种路由模式被称为**injvm模式**。

*injvm*协议是一个伪协议，它不开其端口，也不发起远程服务调用，优先调用JVM内部的服务提供者。如果用户配置了该模式，则优先寻找本JVM内部服务提供者，如果没找到，
则发起远程服务调用。**对于上层用户而言，不感知具体的调用方式。**

### innative 模式

服务路由时优先选择本地的服务提供者，如果找不到，再发起远程服务调用，该模式为*innative*模式。
它的优点在于,通信流量走本地网卡回环，不需要占用网络带宽。另外，可靠性更强，服务调用时延也更低，更节省带宽等资源。

## 路由规则

### 条件路由规则

条件路由的场景如下：
1. 通过IP条件表达式进行黑白名单访问控制。
2. 流量引导，只暴露部分服务提供者，防止整个集群服务都被冲跨，导致其他服务也不可用。
3. 读写分离。
4. 前后台分离。
5. 灰度升级，将Web前台应用路由到**新的服务版本**上。

基于条件表达式的路由规则主要用于地址二次过滤，它由两部分组成：**规则和表达式。**

条件规则由两部分组成：消费者规则和服务提供者规则，可以用分隔符将他们隔离开。
对空条件规则的支持：如果匹配条件为空，表示对所有消费方都适用。如果过滤条件为空，表示禁止访问所有服务提供者。

表达式由三部分组成：
1. 参数。主要包括服务提供者的属性信息、消费者的属性信息。
2. 条件。
3. 值。

### 脚本路由规则

脚本路由规则的特点是通常都支持动态编译，修改后可以实时生效，不需要重启系统，这在线上动态调整路由规则时非常有效。

## 路由规则定制

自定义路由的场景主要如下：
1. 灰度升级，用户需要按照业务规则进行灰度路由。
2. 服务故障、业务高峰期的导流。
3. 与业务领域强相关的非通用路由定制需求。

**路由扩展策略如下：**
* 平台提供路由接口供用户使用。
* 平台提供路由配置XML Schema定义，支持用户扩展路由规则。
* 业务发布自定义路由策略。

## 配置化路由

路由配置策略如下：
1. 本地配置。包括服务提供者、服务消费者、默认全局配置三种。
2. 统一注册管理。本地配置的路由策略统一注册到服务注册中心，进行集中化配置管理。
3. 动态下发。通过服务治理Portal修改路由规则，更新后的路由规则被持久化到服务注册中心。服务注册中心将变更后的服务路由策略或规则下发到服务提供者和消费者，
消费者更新路由规则库，按照新的路由规则执行，实现路由的动态刷新。

路由配置的优先级：**客户端配置 > 服务端配置 > 全局配置**。

服务提供者