# 通信框架

## 关键技术点分析

### 长连接还是短连接

绝大多数分布式服务框架都推荐**长连接**进行内部通信，原因如下：
1. 相比于短连接，长连接更节省资源。长连接在链路创建成功之后服务提供者和消费者之间会通过业务消息和心跳维系链路，实现多消息复用同一个链路节省资源。
2. 远程通信是常态。相比一次简单的服务调用，链路的重建通常耗时更多。

### BIO还是NIO

## 功能设计

分布式服务框架的底层通信框架首先是一个**通用的**通信框架，他不应该与具体的协议绑定。基于通信框架之上，可以构建私有或公有协议栈。

### 服务端设计

通信框架服务端职责如下：
1. 提供上层API，用于初始化服务端实例，设置服务端通信相关参数，
2. 提供可扩展的编解码插件，用户可以通过扩展的方式实现自定义协议的编码和解码
3. 提供拦截面，用于私有协议栈开发

服务端最重要的设计原则：
1. 服务端只提供上层API，不与任何具体协议绑定
2. 服务端提供给用户的API要尽量屏蔽底层的通信细节，防止底层变更引起上层级联变动
3. 服务端功能上不要求全，重点在可扩展性上


## 可靠性设计

在客户端和服务端进行网络通信时，网络闪断、网络超时、通信对端宕机等故障时有发生，为了**保证异常系统下系统的可用性**，通信框架必须必备很高的可靠性。

### 链路有效性检测

心跳检测分为三个层面：
1. TCP层面的心跳检测，即TCP的`keep-alive`机制，它的作用域是整个TCP协议栈。
2. 协议层的心跳检测，主要存在于长连接协议中。
3. 应用层的心跳检测，它主要由各业务产品通过约定方式定时给对方发送心跳消息实现。

> 心跳检测的目的就是确认当前链路可用，对方或者并且能够正常接收 和发送消息。

心跳检测机制主要分为两类：
1. `ping-pong`型心跳，属于请求响应型心跳。
2. `pint-ping`型心跳，不区分心跳请求和应答，由通信双方按照约定定时向对方发送心跳*Ping*消息，它属于双向心跳。

心跳检测策略如下：
1. 连续N、次心跳检测都没有收到对方的消息，则认为链路已发生逻辑失效，这被称为**心跳超时**。
2. 读取或发送心跳消息的时候如果发生IO异常，说明链路已经失效，这被称为**心跳失败**。

以上两种情况都需要关闭链路，由客户端发起重连操作，保证链路能够恢复正常。

### 消息缓存重发

当调用消息发送接口的时候，消息并没有被真正的写入到Socket中，而是先放入NIO通信框架的消息发送队列中，由`Reactor`线程扫描待发送的消息队列，异步的发送给消息对端。

### 资源优雅释放

首先标记系统为退出状态，不再接收新的消息，然后将积压的消息处理完，最后调用资源回收接口将资源销毁，最后各线程执行退出。

## 性能设计

性能差的原因：
1. 网络传输方式问题。同步调用不具备弹性伸缩能力。
2. 序列化性能差。
    * Java序列化机制是Java内部的一种对象编解码技术，无法跨语言使用。
    * 相比如其他序列化机制，Java序列后的码流太大，无论是网络传输还是持久化到硬盘，都会导致额外的资源占用。
    * 序列化性能差，资源占用率高(主要是CPU资源占用)。
3. 线程模型问题。同步阻塞IO会导致每个TCP连接占用1个线程，线程资源是JVM非常宝贵的资源，会导致系统性能急剧下降。

### 通信性能三原则

1. 传输。用什么样的通道将数据发送给对方。
2. 协议。用什么样的通信协议。相比如公有协议，内部私有协议通常性能更优。
3. 线程。