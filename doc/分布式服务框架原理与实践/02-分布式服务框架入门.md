# 分布式服务框架入门

## 分布式框架诞生背景

当业务发展到一定的阶段之后，会面临很多新的挑战，已有技术架构无法支撑业务快速发展等。

### 应用从集中式走向分布式

有些问题无法通过扩容的方式解决，如：
1. 业务不断发展，应用规模日趋庞大。大型复杂应用的开发维护成本高，部署效率低。
2. 代码复用是难题。

> 大规模系统架构的设计一般原则就是尽可能地拆分，以达到更好的独立扩展与伸缩、更灵活的部署、更好的隔离和容错、更高的开发效率。

具体的拆分策略大体上可以分为横向切分和纵向切分。
* 纵向切分。通过对业务梳理，**根据业务的特性**把应用拆开，不同的业务模块独立部署。将复杂的业务拆分成相对独立、灵活的**具体能力域**，由大变小，分而治之。
* 横向切分。将核心的、公共的业务拆分出来，通过分布式框架对业务进行服务化，消费者通过标准的契约来消费这些服务。服务提供者独立打包、部署和演进，与消费者解耦。

### 亟需服务治理

随着服务数的增多，亟需一个服务治理框架，**有效管控服务、提升服务运行质量，防止业务服务代码架构腐化。**

服务治理的主要诉求要求如下：
1. 生命周期管理。服务上线随意，线上服务鱼龙混杂，上线容易下线难。服务上线前的审批流程、测试发布流程和服务下线通知机制需要规范化。
2. 服务容量规划。
3. 运行治理。系统资源成为瓶颈时，对非核心服务采取降级、限流措施，保证核心业务的运行。缓存失效时，系统压力会转移到数据库，服务调用时延增大，业务失败率升高，需要在线
调大服务调用超时时间。
4. 服务安全。相同的服务，对内部消费者和第三方消费者提供的能力存在差异。**如何对不同的消费者做不同的权限控制。**服务化之后，服务的安全控制是服务治理的核心功能之一。

典型的SOA服务治理声明周期如下：
* 计划，确定服务治理的重点。
* 定义，定义服务治理模型。
* 启用，实现并实施服务治理。
* 度量，根据实施效果，改进服务治理模型。

## 业界分布式服务框架介绍

1. 阿里的*Dubbo*，它的工作原理如下：
    1. 轻量级Java容器通过`main`函数初始化Spring上下文，根据**服务提供者**配置的XML文件将服务按照指定协议发布，完成服务的初始化工作。
    2. **服务提供者**根据配置的**服务注册中心**地址连接服务注册中心，将服务提供者消息发布到服务注册中心。
    3. **消费者**根据服务消费者XML配置文件的**服务引用信息**，连接注册中心，获取指定的服务的地址等路由信息。
    4. 服务注册中心根据**服务订阅关系**，动态地向服务消费者**推送**服务地址信息。
    5. 消费者调用远程服务时，根据路由策略，从本地缓存的服务提供者地址列表中选择一个服务提供者，然后根据协议类型建立链路，跨进程调用服务提供者。
    
    该框架的主要质量熟悉如下：
    1. 连通性
        * 注册中心负责服务指定的注册与查找，相当于**服务目录**，服务提供者与消费者只在启动时与注册中心交互，注册中心不转发请求，压力较小。
        * 监控中心负责统计各服务调用的次数，调用时间等。统计现在内存汇总后每分钟一次发送到监控中心服务器，并以报表展示。
        * 服务消费者向注册中心获取服务提供者地址列表，并根据负载算法直接调用提供者，同时汇报调用时间到监控中心。
        * 服务注册中心、服务提供者、服务消费者之间均为**长连接**，监控中心除外。
        * 注册中心通过长连接感知服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者。
        * 注册中心和监控中心全部宕机，不影响已存在的提供者和消费者，消费者在**本地缓存提供者列表**。
        * 注册中心与监控中心都是可选的，消费者可以直连提供者。
    2. 健壮性
        * 监控中心宕机不影响使用，只是丢失部分采样数据。
        * 数据库宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新的服务。
        * 注册中心对等集群，任意一台宕掉后，将自动切换到另一台。
        * 注册中心全部宕掉后，服务提供者仍能通过缓存通信。
        * 服务提供者无状态，任意一台宕掉后不影响使用。
        * 提供者全部宕掉后，消费者应用将无法使用，并**无限次重连**等待服务提供者恢复。
    3. 伸缩性
        * 注册中心为**对等集群**，可动态增加机器部署实例，所有用户端将**自动发现**新的注册中心。
        * 服务提供者**无状态**，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给消费者。
    4. 扩展性
        * 微内核+插件式设计，平等对待第三方。
        * 管道式设计，服务调用前后提供拦截面。
        * 原子化扩展点，最大化复用和扩展。**扩展点是单个功能的抽象，只负责完成一件事。**
2. 淘宝HSF
3. 亚马逊Coral Service

## 分布式服务框架设计

### 框架原理

通常，分布式服务框架可以抽象为三层：

1. RPC层，包括底层通信框架、序列化和反序列化框架、用于屏蔽底层通信协议细节和序列化方式差异的`Remoting`框架。
2. Filter Chain层。服务调用职责链，提供多种服务调用切面供框架自身和使用者扩展。例如：
    * 负载均衡
    * 服务调用性能统计
    * 服务调用完成通知机制
    * 失败重发
    * ...
3. Service层，主要包括Java动态代理，Java反射。

分布式框架通常还会包含两个重要功能：服务治理中心和服务注册中心。
> 服务注册中心负责服务的发布和通知，通常支持对等集群部署，某个服务注册中心宕机并不影响整个服务注册中心集群不可用。
> 服务治理中心通常包含服务治理接口和服务治理Portal，目标就是持续优化服务，防止服务架构腐化，保证服务高质量运行。

### 功能特性

需要支持的功能特性：
1. 服务订阅发布
    1. 配置化发布和引用服务
    2. 服务自动发现机制
    3. 服务在线注册和去注册
2. 服务路由
    1. 默认提供随机路由、轮循、基于权重的路由策略等
    2. 粘滞连接，总是向同一个提供方发起请求，除非此提供方挂掉，在切换到另一台
    3. 路由定制
3. 集群容错
    1. Failover，失败自动切换
    2. Failback，失败自动恢复，后台记录失败请求
    3. Failfast，快速失败，只发起一次调用，失败立即报错