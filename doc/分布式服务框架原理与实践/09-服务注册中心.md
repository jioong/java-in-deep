# 服务注册中心

如何有效的管理服务的订阅/发布，避免硬编码地址信息是分布式服务框架需要解决的一个问题。**通过将服务统一管理起来，**可以有效地优化内部应用对服务发布/使用的
流程和管理，**服务注册中心**就是专门用来管理服务订阅/发布的 **配置管理节点。**

## 概念

1. 服务提供者，服务提供者是发布服务的服务提供方，它通常是一个简单的Java实现类。  
2. 服务消费者，是调用远程服务的消费方。
3. 服务注册中心，是分布式服务框架的目录服务器。相比如传统的目录服务器，有以下几个特点：
    1. 高HA，支持数据持久化、支持集群。
    2. 数据一致性问题，集群中的所有客户端应该看到同一份数据。
    3. 数据变更主动推送，当注册中心的数据发生变更时，需要能够及时将变化的数据通知客户端。
    
## 关键功能特性设计

当服务越来越多的时候，服务URL配置管理变得非常困难。需要服务注册中心，动态地注册和发现服务，**使服务的位置透明。**

服务注册中心的工作原理：
1. 服务提供者在启动的时候，根据服务发布文件中配置的服务发布信息向注册中心注册自己提供的服务。
2. 服务消费者在启动的时候，根据消费者配置文件中配置的服务消费信息向注册中心订阅自己所需的服务，消费者刷新本地缓存的路由列表。
3. 注册中心返回服务提供者地址列表给消费者。如果有变更，注册中心主动推送变更数据给消费者，消费者刷新本地缓存的路由表。
4. 服务消费者从本地缓存的服务提供者地址列表中，基于负载均衡算法选择一台服务提供者进行调用。

### 支持对等集群

服务注册中心需要支持对等集群，当其中一个或多个服务注册中心宕机的时候，不会导致服务注册中心集群功能不可用。

### 提供CRUD接口

客户端连接服务注册中心之后，需要能够对服务注册中心的数据进行操作。通常要进行的接口操作包括：
1. 查询接口，查询系统当前发布的服务信息和订阅的消费者信息。
2. 修改接口，修改已发布的服务属性或消费者属性信息，通常用于**运行时的服务治理**。
3. 新增接口，发布或者订阅新的服务。
4. 删除接口，去注册已发布的接口，或者消费者取消订阅关系。

### 安全加固

主要涉及两部分：
1. 链路的安全性。指服务注册中心对客户端的链接进行安全认证。
2. 数据的安全性。
    1. 非授权客户端不能读写数据。
    2. 普通运维人员只能读数据，不能修改数据。
    3. 管理员可以读、修改数据。
    4. 不同的服务目录可以设置不同的服务权限。
    
### 订阅发布机制

订阅发布机制的优点：
1. 透明化路由，服务提供者和消费者相互解耦，服务提供者位置透明。
2. 服务健康状态检测，服务注册中心可以实时检测发布服务的质量，如果服务提供者宕机，注册中心实时通知消费者。
3. 弹性伸缩能力(动态发现)。

### 可靠性

* 服务注册中心集群中任意一个或多个服务宕机，不影响集群的使用。
* 如果集群全部宕机，只影响新的服务、已发布服务的下线，不影响正常服务的运行和调用。

## 基于ZooKeeper的服务注册中心设计

### 服务订阅发布流程设计

1. ZooKeeper客户端通过创建`org.apache.zookeeper.ZooKeeper`的一个实例对象连接ZooKeeper服务器，然后调用这个类提供的接口来和服务器交互。
2. 根据服务提供者发布的服务列表，创建目录节点，然后将服务属性写入目录节点的内容中。